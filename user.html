<!DOCTYPE html>
<html>
<head>
    <title>User - Emergency Request</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body { font-family: Arial; text-align: center; }
        #map { height: 400px; margin-top: 10px; }
        button { padding: 10px; margin-top: 10px; }
    </style>
</head>
<body>
<div id="map" style="height: 400px;"></div>
<h2>User Emergency Panel</h2>

<button onclick="requestAmbulance()">Request Ambulance</button>

<div id="map"></div>

<script>
const socket = new WebSocket("ws://localhost:3000");

let map = L.map('map').setView([20.2961, 85.8245], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
}).addTo(map);

let userMarker;
let ambulanceMarker;

function requestAmbulance() {
    navigator.geolocation.getCurrentPosition(position => {

        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        userMarker = L.marker([lat, lng]).addTo(map)
            .bindPopup("You (Patient)").openPopup();

        socket.send(JSON.stringify({
            type: "emergency",
            lat: lat,
            lng: lng
        }));

        alert("Emergency request sent to nearby ambulances!");
    });
}

socket.onmessage = function(event) {
    const data = JSON.parse(event.data);

    if (data.type === "locationUpdate") {

        if (!ambulanceMarker) {
            ambulanceMarker = L.marker([data.lat, data.lng]).addTo(map)
                .bindPopup("Ambulance");
        } else {
            ambulanceMarker.setLatLng([data.lat, data.lng]);
        }
    }
};
</script>

</body>
</html>