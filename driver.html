<!DOCTYPE html>
<html>
<head>
  <title>Responder Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>

<body>

<h2>ðŸš‘ Driver Panel</h2>

<div id="map" style="height:400px;"></div>

<div id="requestBox"></div>

<button id="arrivedBtn" style="display:none;">Mark Arrived</button>

<script>
const map = L.map('map').setView([20.2961, 85.8245], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap'
}).addTo(map);

const socket = new WebSocket("ws://localhost:3000");

let ambulanceMarker;
let userMarker;

socket.onmessage = function(event) {
  const data = JSON.parse(event.data);

  if (data.type === "emergency") {

    document.getElementById("requestBox").innerHTML = `
      <p>ðŸš¨ New Emergency Request</p>
      <button onclick="acceptRequest(${data.lat}, ${data.lng})">Accept</button>
      <button onclick="rejectRequest()">Reject</button>
    `;

    userMarker = L.marker([data.lat, data.lng]).addTo(map)
      .bindPopup("Patient Location")
      .openPopup();

    map.setView([data.lat, data.lng], 14);
  }
};

function acceptRequest(userLat, userLng) {

  socket.send(JSON.stringify({
    type: "accepted"
  }));

  document.getElementById("requestBox").innerHTML = "âœ… Request Accepted";
  document.getElementById("arrivedBtn").style.display = "block";

  startTracking();
}

function rejectRequest() {
  document.getElementById("requestBox").innerHTML = "âŒ Request Rejected";
}

function startTracking() {

  navigator.geolocation.watchPosition(position => {

    const lat = position.coords.latitude;
    const lng = position.coords.longitude;

    socket.send(JSON.stringify({
      type: "locationUpdate",
      lat: lat,
      lng: lng
    }));

    if (!ambulanceMarker) {
      ambulanceMarker = L.marker([lat, lng]).addTo(map)
        .bindPopup("ðŸš‘ Ambulance");
    } else {
      ambulanceMarker.setLatLng([lat, lng]);
    }

  }, () => alert("Location permission required"));
}

document.getElementById("arrivedBtn").addEventListener("click", () => {

  socket.send(JSON.stringify({
    type: "arrived"
  }));

  alert("Marked as Arrived");
});
</script>

</body>
</html>